# PipeWire configuration for Fosi Audio K7 DAC/Amp
#
# This configuration supports both UAC 1.0 and UAC 2.0 modes.
# The actual device capabilities are detected and configured by WirePlumber.
#
# Fosi Audio K7 Specifications:
#   - DAC: ES9038Q2M
#   - Headphone Amp: Dual CS43198  
#   - USB: Dual mode - UAC 2.0 (high-res) / UAC 1.0 (compatibility + microphone)
#
# UAC 2.0 Mode (High Resolution):
#   - PCM: 32-bit up to 384kHz (768kHz reported but unstable on Linux)
#   - DSD: Native DSD up to DSD256
#   - Sample rates: 44.1, 48, 88.2, 96, 176.4, 192, 352.8, 384 kHz
#   - No microphone input
#
# UAC 1.0 Mode (Compatibility + Microphone):
#   - PCM: 16-bit at 44.1kHz or 48kHz only
#   - Microphone input available (48kHz/16-bit)
#   - Simultaneous recording and playback
#
# Switch modes by pressing the UAC button on the device.
#
# ============================================================================
# DSD PLAYBACK GUIDE (UAC 2.0 Mode Only)
# ============================================================================
#
# The K7 supports DSD via two methods:
#
# 1. DoP (DSD over PCM) - Works through PipeWire
#    - DSD64  (2.8MHz)  → transmitted as 176.4kHz PCM
#    - DSD128 (5.6MHz)  → transmitted as 352.8kHz PCM
#    - Player sends DoP-encoded stream, DAC detects and decodes
#
# 2. Native DSD - Bypasses PipeWire (best quality)
#    - Requires player to output directly to ALSA: hw:1,0 or hw:K7,0
#    - Supported: DSD64, DSD128, DSD256
#
# Recommended Players:
#   - MPV: supports DoP, configure with --audio-device=alsa/hw:K7,0
#   - Deadbeef: GUI player with DSD plugin
#   - Strawberry: Qt player with native DSD support
#
# Test DSD playback (after installing mpv):
#   mpv --audio-device=alsa/iec958:K7 your-file.dsf
#
# For native DSD (bypassing PipeWire):
#   mpv --audio-device=alsa/hw:K7,0 --audio-spdif=dsd your-file.dsf
# ============================================================================

context.properties = {
    # Default sample rate - 48kHz for compatibility with both UAC modes
    # WirePlumber will override this based on detected device capabilities
    default.clock.rate = 48000

    # All sample rates supported by the Fosi Audio K7 in UAC 2.0 mode
    # In UAC 1.0 mode, WirePlumber will restrict to 44.1/48kHz only
    #
    # 44.1kHz family: 44100, 88200, 176400, 352800
    # 48kHz family:   48000, 96000, 192000, 384000
    #
    # Note: 705.6kHz and 768kHz are reported by device but don't work reliably on Linux
    default.clock.allowed-rates = [ 44100, 48000, 88200, 96000, 176400, 192000, 352800, 384000 ]

    # Larger quantum for stability at high sample rates (UAC 2.0)
    # 2048 samples @ 384kHz = 5.3ms latency - prevents crackling
    # 2048 samples @ 48kHz = 42.6ms latency - still acceptable for UAC 1.0
    default.clock.quantum = 2048
    default.clock.min-quantum = 1024
    default.clock.max-quantum = 8192

    # Do not force a specific rate - allow automatic rate switching
    # WirePlumber will configure the appropriate rate based on UAC mode
    # default.clock.force-rate = 48000
}

